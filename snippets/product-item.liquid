{% comment %}
  Renders a product card

  Accepts:
  - card_product: {Object} Product Liquid object (optional)
  - media_aspect_ratio: {String} Size of the product image card. Values are "square" and "portrait". Default is "square" (optional)
  - image_shape: {String} Image mask to apply to the product image card. Values are "arch", "blob", "chevronleft", "chevronright", "diamond", "parallelogram", and "round". (optional)
  - show_secondary_image: {Boolean} Show the secondary image on hover. Default: false (optional)
  - show_vendor: {Boolean} Show the product vendor. Default: false
  - show_rating: {Boolean} Show the product rating. Default: false
  - extend_height: {Boolean} Card height extends to available container space. Default: true (optional)
  - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)
  - quick_add: {Boolean} Show the quick add button.
  - section_id: {String} The ID of the section that contains this card.
  - horizontal_class: {Boolean} Add a card--horizontal class if set to true. Default: false (optional)
  - horizontal_quick_add: {Boolean} Changes the quick add button styles when set to true. Default: false (optional)
  - placeholder_image: {String} The placeholder image to use when no product exists. Default: 'product-apparel-2' (optional)

  Usage:
  {% render 'card-product', show_vendor: section.settings.show_vendor %}
{% endcomment %}
{%- unless skip_styles -%}
  <link
    rel="stylesheet"
    href="{{ 'component-rating.css' | asset_url }}"
    media="print"
    onload="this.media='all'"
  >

  <link
    rel="stylesheet"
    href="{{ 'component-volume-pricing.css' | asset_url }}"
    media="print"
    onload="this.media='all'"
  >
  <link
    rel="stylesheet"
    href="{{ 'component-card.css' | asset_url }}"
    media="print"
    onload="this.media='all'"
  >
  <link
    rel="stylesheet"
    href="{{ 'component-price.css' | asset_url }}"
    media="print"
    onload="this.media='all'"
  >
  <link
    rel="stylesheet"
    href="{{ 'quick-order-list.css' | asset_url }}"
    media="print"
    onload="this.media='all'"
  >
  <link
    rel="stylesheet"
    href="{{ 'quantity-popover.css' | asset_url }}"
    media="print"
    onload="this.media='all'"
  >
{%- endunless -%}
{%- if card_product and card_product != empty -%}
  {%- liquid
    assign ratio = 1
    if card_product.featured_media and media_aspect_ratio == 'portrait'
      assign ratio = 0.8
    elsif card_product.featured_media and media_aspect_ratio == 'adapt'
      assign ratio = card_product.featured_media.aspect_ratio
    endif
    if ratio == 0 or ratio == null
      assign ratio = 1
    endif
  -%}
  <div class="card-wrapper product-card-wrapper">
    <div
      class="
        card card--card card--media
        {% if card_product.featured_media == nil %} ratio{% endif %}
         {% if horizontal_class %} card--horizontal{% endif %}
      "
      style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;"
    >
      <a
        href="{{ card_product.url }}"
        id="CardLink-{{ section_id }}-{{ card_product.id }}"
        class="full-unstyled-link"
        aria-labelledby="CardLink-{{ section_id }}-{{ card_product.id }} Badge-{{ section_id }}-{{ card_product.id }}"
        style="margin: 0;"
      >
        <div
          class="card__inner {% if card_product.featured_media %} ratio{% endif %}"
          style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;"
        >
          {%- if card_product.featured_media -%}
            <div class="card__media">
              <div class="media media--transparent media--hover-effect">
                {% render 'product-featured-responsive-image', image: card_product.featured_media %}

                {% render 'product-secondary-responsive-image',
                  image: card_product.media[1],
                  show_secondary_image: show_secondary_image
                %}
              </div>
            </div>
          {%- endif -%}
        </div>
      </a>
      <div class="card__content">
        <div class="card__information">
          <h3
            class="card__heading h6"
            {% if card_product.featured_media %}
              id="title-{{ section_id }}-{{ card_product.id }}"
            {% endif %}
          >
            <a
              href="{{ card_product.url }}"
              id="CardLink-{{ section_id }}-{{ card_product.id }}"
              class="full-unstyled-link"
              aria-labelledby="CardLink-{{ section_id }}-{{ card_product.id }} Badge-{{ section_id }}-{{ card_product.id }}"
            >
              {{ card_product.title | escape }}
            </a>
          </h3>
          <div class="card-information">
            {%- if show_vendor -%}
              <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
              <div class="vendor-name">{{ card_product.vendor }}</div>
            {%- endif -%}

            <span class="caption-large light">{{ block.settings.description | escape }}</span>

            {%- if show_rating and card_product.metafields.reviews.rating.value != blank -%}
              {% liquid
                assign rating_decimal = 0
                assign decimal = card_product.metafields.reviews.rating.value.rating | modulo: 1
                if decimal >= 0.3 and decimal <= 0.7
                  assign rating_decimal = 0.5
                elsif decimal > 0.7
                  assign rating_decimal = 1
                endif
              %}
              <div
                class="rating"
                role="img"
                aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: card_product.metafields.reviews.rating.value, rating_max: card_product.metafields.reviews.rating.value.scale_max }}"
              >
                <span
                  aria-hidden="true"
                  class="rating-star"
                  style="--rating: {{ card_product.metafields.reviews.rating.value.rating | floor }}; --rating-max: {{ card_product.metafields.reviews.rating.value.scale_max }}; --rating-decimal: {{ rating_decimal }};"
                ></span>
              </div>
              <p class="rating-text caption">
                <span aria-hidden="true">
                  {{- card_product.metafields.reviews.rating.value }} /
                  {{ card_product.metafields.reviews.rating.value.scale_max -}}
                </span>
              </p>
              <p class="rating-count caption">
                <span aria-hidden="true">({{ card_product.metafields.reviews.rating_count }})</span>
                <span class="visually-hidden">
                  {{- card_product.metafields.reviews.rating_count }}
                  {{ 'accessibility.total_reviews' | t -}}
                </span>
              </p>
            {%- endif -%}

            <div
              class="loox-rating"
              data-id="{{ card_product.id }}"
              data-rating="{{ card_product.metafields.loox.avg_rating }}"
              data-raters="{{ card_product.metafields.loox.num_reviews }}"
            ></div>
            {% render 'price', product: card_product, price_class: '', show_compare_at_price: true %}
          </div>
        </div>
        {%- if show_quick_add -%}
          <div class="quick-add no-js-hidden">
            {%- liquid
              assign product_form_id = 'quick-add-' | append: section_id | append: card_product.id
              assign qty_rules = false
              if card_product.selected_or_first_available_variant.quantity_rule.min > 1 or card_product.selected_or_first_available_variant.quantity_rule.max != null or card_product.selected_or_first_available_variant.quantity_rule.increment > 1
                assign qty_rules = true
              endif
            -%}
            {%- if card_product.variants.size > 1
              and card_product.selected_or_first_available_variant.available
              or qty_rules
            -%}
              <modal-opener data-modal="#QuickAdd-{{ card_product.id }}">
                <button
                  id="{{ product_form_id }}-submit"
                  type="submit"
                  name="add"
                  class="quick-add__submit button button--full-width button--primary product-card-button{% if horizontal_quick_add %} card--horizontal__quick-add animate-arrow{% endif %}"
                  aria-haspopup="dialog"
                  aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                  data-product-url="{{ card_product.url }}"
                >
                  {{ 'products.product.choose_options' | t }}
                  {%- if horizontal_quick_add -%}
                    <span class="icon-wrap">
                      {{- 'icon-arrow.svg' | inline_asset_content -}}
                    </span>
                  {%- endif -%}
                  {%- render 'loading-spinner' -%}
                </button>
              </modal-opener>
              <quick-add-modal id="QuickAdd-{{ card_product.id }}" class="quick-add-modal">
                <div
                  role="dialog"
                  aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
                  aria-modal="true"
                  class="quick-add-modal__content global-settings-popup"
                  tabindex="-1"
                >
                  <button
                    id="ModalClose-{{ card_product.id }}"
                    type="button"
                    class="quick-add-modal__toggle"
                    aria-label="{{ 'accessibility.close' | t }}"
                  >
                    {{- 'icon-close.svg' | inline_asset_content -}}
                  </button>
                  <div id="QuickAddInfo-{{ card_product.id }}" class="quick-add-modal__content-info"></div>
                </div>
              </quick-add-modal>
            {%- else -%}
              <product-form data-section-id="{{ section.id }}">
                {%- form 'product',
                  card_product,
                  id: product_form_id,
                  class: 'form',
                  novalidate: 'novalidate',
                  data-type: 'add-to-cart-form'
                -%}
                  <input
                    type="hidden"
                    name="id"
                    value="{{ card_product.selected_or_first_available_variant.id }}"
                    class="product-variant-id"
                    {% if card_product.selected_or_first_available_variant.available == false %}
                      disabled
                    {% endif %}
                  >
                  <button
                    id="{{ product_form_id }}-submit"
                    type="submit"
                    name="add"
                    class="quick-add__submit button button--full-width button--primary product-card-button{% if horizontal_quick_add %} card--horizontal__quick-add{% endif %}"
                    aria-haspopup="dialog"
                    aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                    aria-live="polite"
                    data-sold-out-message="true"
                    {% if card_product.selected_or_first_available_variant.available == false %}
                      disabled
                    {% endif %}
                  >
                    <span class="add_btn_text">
                      {%- if card_product.selected_or_first_available_variant.available -%}
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="17"
                          viewBox="0 0 16 17"
                          fill="var(--color-button-text)"
                        >
                          <path fill-rule="evenodd" clip-rule="evenodd" d="M8.17544 0.25C6.41928 0.25 4.99561 1.64911 4.99561 3.375V4H3.59019C2.61803 4 1.80132 4.71838 1.69397 5.66794L0.704691 14.4179C0.579113 15.5286 1.46378 16.5 2.60092 16.5H10.0833C10.4346 16.5 10.7193 16.2202 10.7193 15.875C10.7193 15.5298 10.4346 15.25 10.0833 15.25H2.60092C2.22187 15.25 1.92698 14.9262 1.96884 14.556L2.95812 5.806C2.9939 5.48944 3.26614 5.25 3.59019 5.25H4.99561V6.5C4.99561 6.84519 5.28033 7.125 5.63158 7.125C5.98282 7.125 6.26754 6.84519 6.26754 6.5V5.25H10.0833V6.5C10.0833 6.84519 10.3681 7.125 10.7193 7.125C11.0705 7.125 11.3553 6.84519 11.3553 6.5V5.25H12.7607C13.0848 5.25 13.357 5.48944 13.3928 5.806L13.903 10.319C13.9418 10.6621 14.2562 10.9093 14.6054 10.8712C14.9544 10.8331 15.206 10.5241 15.1672 10.181L14.6569 5.66794C14.5496 4.71838 13.7329 4 12.7607 4H11.3553V3.375C11.3553 1.64911 9.93159 0.25 8.17544 0.25ZM10.0833 4V3.375C10.0833 2.33947 9.22917 1.5 8.17544 1.5C7.12177 1.5 6.26754 2.33947 6.26754 3.375V4H10.0833Z" fill="var(--color-button-text)"/>
                          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.8991 12.125C13.8991 11.7798 13.6144 11.5 13.2632 11.5C12.9119 11.5 12.6272 11.7798 12.6272 12.125V13.375H11.3553C11.004 13.375 10.7193 13.6548 10.7193 14C10.7193 14.3452 11.004 14.625 11.3553 14.625H12.6272V15.875C12.6272 16.2202 12.9119 16.5 13.2632 16.5C13.6144 16.5 13.8991 16.2202 13.8991 15.875V14.625H15.1711C15.5223 14.625 15.807 14.3452 15.807 14C15.807 13.6548 15.5223 13.375 15.1711 13.375H13.8991V12.125Z" fill="var(--color-button-text)"/>
                        </svg>
                        {{ 'products.product.add_to_cart' | t }}
                      {%- else -%}
                        {{ 'products.product.sold_out' | t }}
                      {%- endif -%}
                    </span>
                    <span class="sold-out-message hidden">
                      {{ 'products.product.sold_out' | t }}
                    </span>
                    {%- if horizontal_quick_add -%}
                      <span class="icon-wrap">
                        {{- 'icon-plus.svg' | inline_asset_content -}}
                      </span>
                    {%- endif -%}
                    {%- render 'loading-spinner' -%}
                  </button>
                {%- endform -%}
              </product-form>
            {%- endif -%}
          </div>
        {%- endif -%}
        <div class="card__badge {{ settings.badge_position }}">
          {%- if card_product.available == false -%}
            <span
              id="Badge-{{ section_id }}-{{ card_product.id }}"
              class="sold-badge badge badge--bottom-left"
              style="color:{{ settings.sold_text_color }};background-color:{{ settings.sold_bg }}"
            >
              {{- 'products.product.sold_out' | t -}}
            </span>
          {%- elsif card_product.compare_at_price > card_product.price and card_product.available -%}
            <span
              id="Badge-{{ section_id }}-{{ card_product.id }}"
              class="sale-badge badge badge--bottom-left"
              style="color:{{ settings.sale_text_color }};background-color:{{ settings.sale_bg }}"
            >
              {{- 'products.product.on_sale' | t -}}
            </span>
          {%- endif -%}
        </div>
      </div>
    </div>
    <modal-opener data-modal="#QuickAdd-{{ card_product.id }}">
      <button
        id="{{ product_form_id }}-submit"
        type="submit"
        name="add"
        class="eye_btn {% if horizontal_class  %} eye_horizontal {% else %} eye_vertical {% endif %}"
        aria-haspopup="dialog"
        aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
        data-product-url="{{ card_product.url }}"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="26" viewBox="0 0 12 12" fill="none">
          <path d="M7.61373 5.96226C7.61373 6.8325 6.91051 7.53573 6.04026 7.53573C5.17002 7.53573 4.4668 6.8325 4.4668 5.96226C4.4668 5.09202 5.17002 4.38879 6.04026 4.38879C6.91051 4.38879 7.61373 5.09202 7.61373 5.96226Z" stroke="#626262" stroke-width="0.659274" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M6.04041 9.59699C7.5919 9.59699 9.03791 8.6828 10.0444 7.10054C10.44 6.48082 10.44 5.43917 10.0444 4.81945C9.03791 3.23719 7.5919 2.323 6.04041 2.323C4.48892 2.323 3.04291 3.23719 2.03642 4.81945C1.64085 5.43917 1.64085 6.48082 2.03642 7.10054C3.04291 8.6828 4.48892 9.59699 6.04041 9.59699Z" stroke="#626262" stroke-width="0.659274" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>

        {%- render 'loading-spinner' -%}
      </button>
    </modal-opener>
    <quick-add-modal id="QuickAdd-{{ card_product.id }}" class="quick-add-modal">
      <div
        role="dialog"
        aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
        aria-modal="true"
        class="quick-add-modal__content global-settings-popup"
        tabindex="-1"
      >
        <button
          id="ModalClose-{{ card_product.id }}"
          type="button"
          class="quick-add-modal__toggle"
          aria-label="{{ 'accessibility.close' | t }}"
        >
          {% render 'icon-close' %}
        </button>
        <div id="QuickAddInfo-{{ card_product.id }}" class="quick-add-modal__content-info"></div>
      </div>
    </quick-add-modal>
  </div>
{%- else -%}
  {%- liquid
    assign ratio = 1
    assign placeholder = true
    if media_aspect_ratio == 'portrait'
      assign ratio = 0.8
    endif
  -%}
  <div class="card-wrapper product-card-wrapper">
    <div
      class="card card--card card--media"
      style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;"
    >
      <div
        class="card__inner ratio"
      >
        <div
          class="card__media"
        >
          <div
            class="media media--transparent"
          >
            {%- if placeholder_image -%}
              {{ placeholder_image | placeholder_svg_tag: 'placeholder-svg' }}
            {%- else -%}
              {{ 'product-apparel-2' | placeholder_svg_tag: 'placeholder-svg' }}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="card__content">
        <div class="card__information">
          <h3 class="card__heading h6 card__heading--placeholder" style="-webkit-line-clamp: 1;">
            <a role="link" aria-disabled="true" class="card__heading--link">
              {{ 'onboarding.product_title' | t }}
            </a>
          </h3>
          <div class="card-information">
            {%- if show_vendor -%}
              <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
              <div class="vendor-name">{{ 'products.product.vendor' | t }}</div>
            {%- endif -%}
            {% render 'price', placeholder: placeholder, show_compare_at_price: true %}
          </div>
        </div>
      </div>
    </div>
  </div>
{%- endif -%}
